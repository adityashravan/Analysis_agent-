{
  "upgrade": {
    "from_version": "SLES 12 SP5",
    "to_version": "SLES 15 SP4",
    "workload": "Kubernetes"
  },
  "breaking_changes": [
    {
      "component": "Kernel Cgroups Hierarchy",
      "change_type": "breaking",
      "description": "The kernel was upgraded from the SLES 12 series (likely 4.4/4.12) to Linux 5.14. This shift introduces and defaults to a hybrid cgroups setup, enabling Cgroups v2 support. SLES 12 SP5 uses Cgroups v1. This fundamental change in resource accounting breaks older Kubelet versions (pre-1.22) that rely entirely on the Cgroups v1 filesystem layout. Incorrect configuration leads to resource starvation, faulty resource reporting, and broken QoS enforcement.",
      "affected_k8s_components": [
        "kubelet",
        "Container Runtime (CRI-O/Containerd)",
        "Pod Quality of Service (QoS) Enforcement",
        "Resource Quota Enforcement"
      ],
      "impact_severity": "critical"
    },
    {
      "component": "Container Runtime Stack",
      "change_type": "breaking",
      "description": "SLES 12 SP5 clusters likely ran on Docker (using the deprecated docker-shim). SLES 15 SP4 defaults to Podman 4.3.1 and mandates a move to a Container Runtime Interface (CRI) compliant runtime (CRI-O or Containerd). The Docker package and its shim may be entirely removed or unsupported, leading to total node failure if not migrated first.",
      "affected_k8s_components": [
        "Container Runtime (CRI-O/Containerd)",
        "kubelet",
        "Image Registry and Storage Driver configuration"
      ],
      "impact_severity": "critical"
    },
    {
      "component": "Container Networking Host Stack",
      "change_type": "behavioral",
      "description": "Podman 4.x introduces Netavark and Aardvark DNS as the new default host-level container networking stack, replacing the older CNI-based setup for Podman-managed containers. While K8s CNI plugins (Flannel, Calico) should be isolated, the change can affect diagnostic tooling and any host-level security or firewall rules tied to the old networking model.",
      "affected_k8s_components": [
        "Networking Stack (Diagnostics)",
        "Host Services and DaemonSets with network needs"
      ],
      "impact_severity": "high"
    },
    {
      "component": "System Utilities and Scripting Language",
      "change_type": "breaking",
      "description": "Python 2 has been entirely removed from SLES 15 SP4. Any custom automation, deployment scripts, legacy monitoring agents, or pre/post-upgrade tools relying on the `python` executable (Python 2) will fail post-upgrade.",
      "affected_k8s_components": [
        "Setup/Maintenance scripts",
        "Custom Automation/Controllers",
        "Monitoring Agents"
      ],
      "impact_severity": "high"
    },
    {
      "component": "Systemd",
      "change_type": "behavioral",
      "description": "Systemd is updated to v249. This version introduces deprecation warnings, marking systems running the legacy cgroup v1 hierarchy as 'tainted'. Additionally, support for System V init.d scripts is deprecated and should be converted to native systemd units.",
      "affected_k8s_components": [
        "kubelet (systemd unit configuration)",
        "System Daemon stability"
      ],
      "impact_severity": "medium"
    }
  ],
  "kubernetes_impact": [
    {
      "k8s_component": "kubelet",
      "impact_description": "The Kubelet requires the Cgroups driver to match the underlying host OS. A Cgroups v1-configured Kubelet on a Cgroups v2 OS will fail to launch pods or incorrectly enforce CPU/Memory limits, resulting in a non-functional node. The Kubelet unit file must also be managed by systemd for proper v2 integration.",
      "required_actions": [
        "Upgrade Kubernetes to a version supporting Cgroups v2 (v1.22+).",
        "Configure Kubelet with `cgroupDriver: systemd` in `/etc/kubernetes/kubelet.conf`.",
        "Ensure the Kubelet unit file is a native systemd unit (not an init.d wrapper)."
      ]
    },
    {
      "k8s_component": "container runtime",
      "impact_description": "The mandatory migration away from Docker requires a complete shift in container image management, storage (e.g., OverlayFS options, backing store), and host security configurations (SELinux/AppArmor profiles).",
      "required_actions": [
        "Install and configure a modern CRI runtime (e.g., CRI-O or Containerd).",
        "Configure the CRI runtime's systemd unit to ensure correct Cgroup v2 integration.",
        "Migrate or re-configure the storage driver (e.g., ensure `overlay2` is correctly used by the new runtime).",
        "Validate/update SELinux profiles for the new container runtime executable (e.g., `crio`)."
      ]
    },
    {
      "k8s_component": "networking",
      "impact_description": "While pod networking is handled by the cluster's CNI, underlying kernel networking stack changes (Linux 5.14) could introduce new behaviors or require re-tuning of system-level network parameters (e.g., sysctl settings) that may have been implicitly relied upon by the CNI plugin.",
      "required_actions": [
        "Thoroughly test pod-to-pod, pod-to-service, and egress/ingress connectivity post-upgrade.",
        "Review K8s node sysctl requirements (e.g., `net.bridge.bridge-nf-call-iptables=1`) and ensure SLES 15 SP4 still honors them."
      ]
    }
  ],
  "mitigation_steps": [
    {
      "step": "1",
      "action": "Audit all node-level scripts (especially monitoring/setup) for Python 2 reliance and rewrite to Python 3. Remove dependencies on deprecated binaries (e.g., `raw`, `bind-chroot`).",
      "priority": "critical",
      "timing": "pre-upgrade"
    },
    {
      "step": "2",
      "action": "Select a CRI runtime (CRI-O recommended for better systemd integration) and configure its daemon and Kubelet to use the `systemd` cgroup driver.",
      "priority": "critical",
      "timing": "pre-upgrade"
    },
    {
      "step": "3",
      "action": "Perform the OS upgrade to SLES 15 SP4. Immediately after reboot, confirm the running kernel version is 5.14+ and verify the cgroups mount structure (look for unified hierarchy for optimal K8s v1.22+ support).",
      "priority": "critical",
      "timing": "during-upgrade"
    },
    {
      "step": "4",
      "action": "Apply the new CRI runtime and Kubelet configurations. Ensure old Docker/init.d services are disabled, and the new runtime and Kubelet services are enabled via systemd.",
      "priority": "high",
      "timing": "post-upgrade"
    },
    {
      "step": "5",
      "action": "Conduct a full functional test: deploy a Pod with Guaranteed QoS and check its Cgroups path in `/sys/fs/cgroup/` to ensure the correct v2 resource limits are being created and enforced.",
      "priority": "high",
      "timing": "post-upgrade"
    }
  ],
  "recommendations": [
    "Use a tool like YaST/Zypper or an automation framework to manage the SLES 12 to 15 major version jump, which simplifies module and package management.",
    "For the least friction, ensure the Kubernetes cluster is running a version that officially supports and defaults to Cgroups v2 (Kubernetes v1.25 or newer) before attempting the OS upgrade.",
    "Implement a dedicated, small node pool running SLES 15 SP4 to canary test workloads before upgrading the entire fleet.",
    "Monitor host logs for systemd 'tainted' warnings, as this indicates a reliance on deprecated cgroups behavior that will break in future major SUSE releases."
  ]
}
